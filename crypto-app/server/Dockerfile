FROM oven/bun:1.1

WORKDIR /app

COPY . .

RUN bun install

RUN bunx prisma generate --schema=prisma/schema.prisma

RUN echo '#!/bin/bash\n\
  set -e\n\
  \n\
  echo "ðŸ”„ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ PostgreSQL..."\n\
  \n\
  until bunx prisma db push --schema=prisma/schema.prisma --accept-data-loss 2>/dev/null; do\n\
  echo "â³ PostgreSQL Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ - Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ..."\n\
  sleep 2\n\
  done\n\
  \n\
  echo "âœ… PostgreSQL Ð³Ð¾Ñ‚Ð¾Ð²!"\n\
  echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."\n\
  \n\
  exec "$@"' > /wait-for-db.sh && chmod +x /wait-for-db.sh


CMD ["/wait-for-db.sh", "bun", "run", "start"]